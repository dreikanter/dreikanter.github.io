---
title: rm --recursive --brutal
created: 2014/03/05 23:32:25
tags: python, programming
---

Иногда бывает неловко читать утром собственный код, написанный после трёхчасовой отладки скрипта, — того, который предполагалось с нуля довести до рабочего состояния максимум за час.

``` python
def shut_up_and_rmrf(dir_path):
    try:
        shutil.rmtree(dir_path)
    except OSError as e:
        if os.name == 'nt':
            logging.debug("Using system command to delete a directory")
            os.system("rmdir /Q /S \"%s\"" % dir_path)
        else:
            raise
```

Вспоминается вот эта картинка:

[![Но зачем?](http://media.drafts.cc/20060314001600.jpg)](http://borya-spec.livejournal.com/126307.html)

А затем, что в Windows нельзя просто так взять `shutil.rmtree()` и удалить сохранённую фаерфоксом веб-страницу. Этому противостоит [магия](http://msdn.microsoft.com/en-us/library/bb776887%28VS.85%29.aspx#connected), связывающая HTML файл и директорию `*_files` с картинками и прочими сохранёнными вместе с ним ассетами.

Магия, как и положено, работает загадочно. Четыре из пяти тестовых страниц удаляются успешно, а на пятой скрипт спотыкается, пытаясь удалить содержимое `*_files`. При этом путь к файлу в сообщении об ошибке некорректный, — имя директории `*_files` в нём почему-то продублировано. Искомого файла по этому адресу, естесственно, не обнаруживается. В аргумент `rmtree` передаётся гарантированно корректное значение (иначе ошибка проявлялась бы постоянно), из чего можно сделать вывод, что это явный platform-specific баг в модуле `shutil`.

Но это не главное. Это вообще не важно. Обычный полтергейст, дело житейское. Важнее то, что не нужно работать, когда мозг устал. А сложность здесь в том, что интроспекция отрубается гораздо раньше способности, например, фигачить не слишком интеллектуальный код. Энергия заканчивается, качество результата работы падает, настроение — вместе с ним. А туловище продолжает «работать».

Для таких ситуаций нужен своего рода dead man's switch. Внешний протокол или механизм который проконтролирует переход в режим зомби и вежливо но настойчиво отберёт молоток с долотом, и отправит отдыхать.
